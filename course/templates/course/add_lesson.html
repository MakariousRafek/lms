{% extends 'course/base.html' %}
{% block content %}
<style>
    .question-form { border: 2px dashed #f8bbd0; padding: 20px; border-radius: 15px; margin-bottom: 20px; background: #fff; position: relative; }
    .mcq-fields { transition: all 0.3s ease; }
    .form-control { border-radius: 10px; border: 1px solid #f8bbd0; margin-bottom: 10px; }
    .btn-custom { background: linear-gradient(135deg, #c2185b 0%, #f06292 100%); color: white; border-radius: 15px; }
    .btn-custom:hover { color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(194,24,91,0.3); }
</style>

<div class="container mt-4 mb-5">
    <div class="card p-4 shadow-sm" style="border-radius: 20px; border: none;">
        <h3 class="text-center mb-4" style="color: #c2185b;">ğŸ€ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø© ÙˆØ£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>

        <form method="POST">
            {% csrf_token %}

            <div class="mb-4 p-3 bg-light" style="border-radius: 15px;">
                <h5 class="mb-3" style="color: #c2185b;"><i class="fas fa-book-open me-2"></i>1. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø³</h5>
                <div class="row">
                    {% for field in form %}
                    <div class="col-md-6">
                        <label class="fw-bold">{{ field.label }}</label>
                        {{ field }}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <hr class="my-4">

            <div class="mb-4">
                <h5 class="mb-3" style="color: #c2185b;"><i class="fas fa-question-circle me-2"></i>2. Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h5>
                {{ formset.management_form }}

                <div id="questions-container">
                    {% for q_form in formset %}
                    <div class="question-form border-pink">
                        {{ q_form.id }}
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                                <div class="type-selector">{{ q_form.question_type }}</div>
                            </div>
                            <div class="col-md-9 mb-3">
                                <label class="fw-bold">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                                {{ q_form.question_text }}
                            </div>
                        </div>

                        <div class="mcq-fields border-top pt-3">
                            <p class="text-muted small">âš ï¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø§ÙƒØªØ¨ÙŠÙ‡Ø§ ÙÙ‚Ø· Ù„Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</p>
                            <div class="row">
                                <div class="col-md-3"><label>Ø§Ø®ØªÙŠØ§Ø± 1</label>{{ q_form.option_1 }}</div>
                                <div class="col-md-3"><label>Ø§Ø®ØªÙŠØ§Ø± 2</label>{{ q_form.option_2 }}</div>
                                <div class="col-md-3"><label>Ø§Ø®ØªÙŠØ§Ø± 3</label>{{ q_form.option_3 }}</div>
                                <div class="col-md-3"><label>Ø§Ø®ØªÙŠØ§Ø± 4</label>{{ q_form.option_4 }}</div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="fw-bold text-success">Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (1-4):</label>
                                    {{ q_form.correct_option }}
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold">Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                                    {{ q_form.points }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <button type="button" id="add-more" class="btn btn-outline-secondary btn-sm w-100 mt-2 py-2" style="border-radius: 10px; border-style: dashed;">
                    â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¢Ø®Ø±
                </button>
            </div>

            <div class="d-flex justify-content-between mt-5">
                <a href="{% url 'dashboard' %}" class="btn btn-light px-4" style="border-radius: 12px;">ğŸ”™ Ø¹ÙˆØ¯Ø©</a>
                <button type="submit" class="btn btn-custom px-5 py-2 shadow">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© âœ¨</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±)
    function toggleFields(selectElement) {
        let container = selectElement.closest('.question-form');
        let mcqFields = container.querySelector('.mcq-fields');
        if (selectElement.value === 'text') {
            mcqFields.style.display = 'none';
        } else {
            mcqFields.style.display = 'block';
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†ÙˆØ¹
    document.addEventListener('change', function(e) {
        if (e.target && (e.target.name.includes('question_type') || e.target.closest('.type-selector'))) {
            toggleFields(e.target);
        }
    });

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    document.querySelectorAll('select[name$="question_type"]').forEach(select => {
        toggleFields(select);
    });

    // ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ (Dynamic Formset)
    document.getElementById('add-more').onclick = function() {
        let container = document.getElementById('questions-container');
        let totalForms = document.getElementById('id_questions-TOTAL_FORMS');
        let formNum = parseInt(totalForms.value);

        // Ø¬Ù„Ø¨ Ø£ÙˆÙ„ ÙÙˆØ±Ù… Ù„Ù†Ø³Ø®Ù‡
        let forms = container.getElementsByClassName('question-form');
        let newForm = forms[0].cloneNode(true);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ù€ IDs
        newForm.innerHTML = newForm.innerHTML.replace(/questions-0/g, `questions-${formNum}`);

        // ØªØµÙÙŠØ± Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        newForm.querySelectorAll('input, textarea, select').forEach(input => {
            if (input.type !== 'hidden') input.value = '';
            if (input.type === 'number' && input.name.includes('points')) input.value = '1';
        });

        totalForms.value = formNum + 1;
        container.appendChild(newForm);

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        toggleFields(newForm.querySelector('select[name$="question_type"]'));
    };
</script>
{% endblock %}